<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดข้อมูลลูกค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        #platformChart {
            max-height: 400px; /* กำหนดความสูงสูงสุดของกราฟ */
        }
    </style>
</head>
<body class="p-6">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">แดชบอร์ดข้อมูลลูกค้า</h1>

        <!-- Data Source Section (Google Sheets URL) -->
        <div id="dataSourceSection" class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">ดึงข้อมูลจาก Google Sheet</h2>
            <p class="text-gray-600 mb-4 text-sm">
                กรุณาใส่ URL ของ Google Sheet ที่ถูกตั้งค่าให้เผยแพร่เป็น CSV แล้ว<br>
                วิธีทำ: ไฟล์ > แชร์ > เผยแพร่ไปยังเว็บ > เลือกแผ่นงาน > รูปแบบ: CSV (ค่าที่คั่นด้วยคอมมา)
            </p>
            <div class="flex flex-col md:flex-row gap-2">
                <input type="text" id="sheetUrl" placeholder="วาง URL ของ Google Sheet (CSV) ที่นี่..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="loadDataBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    ดึงข้อมูล
                </button>
            </div>
            <p id="statusMessage" class="mt-2 text-sm font-medium text-gray-500"></p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- Dashboard Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6 flex items-center justify-between transition transform hover:scale-105">
                    <div>
                        <h3 class="text-lg font-medium text-gray-500">จำนวนผู้ใช้งานทั้งหมด</h3>
                        <p id="userCount" class="text-4xl font-bold text-blue-600 mt-2">...</p>
                    </div>
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 flex items-center justify-between transition transform hover:scale-105">
                    <div>
                        <h3 class="text-lg font-medium text-gray-500">คะแนนความพึงพอใจเฉลี่ย</h3>
                        <p id="avgSatisfaction" class="text-4xl font-bold text-green-600 mt-2">...</p>
                    </div>
                    <div class="bg-green-100 text-green-600 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 flex items-center justify-between transition transform hover:scale-105">
                    <div>
                        <h3 class="text-lg font-medium text-gray-500">การใช้จ่ายเฉลี่ย</h3>
                        <p id="avgSpending" class="text-4xl font-bold text-purple-600 mt-2">...</p>
                    </div>
                    <div class="bg-purple-100 text-purple-600 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">จำนวนผู้ใช้งานในแต่ละแพลตฟอร์ม</h3>
                <canvas id="platformChart"></canvas>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">ข้อมูลทั้งหมด</h3>
                
                <div class="flex flex-col md:flex-row items-center justify-between mb-4">
                    <input type="text" id="searchBox" placeholder="ค้นหาข้อมูล..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2 md:mb-0 md:mr-4">
                    <select id="platformFilter" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>

                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">อายุ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เพศ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แพลตฟอร์มที่ใช้</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">คะแนนความพึงพอใจ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การใช้จ่ายเฉลี่ย</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="noResults" class="hidden text-center py-4 text-gray-500">ไม่พบข้อมูล</div>
            </div>
        </div>
    </div>

    <script>
        const sheetUrlInput = document.getElementById('sheetUrl');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const dataSourceSection = document.getElementById('dataSourceSection');
        const dashboardContent = document.getElementById('dashboardContent');
        const statusMessage = document.getElementById('statusMessage');

        let chartInstance = null; // Variable to hold the chart instance

        // Function to parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) {
                return [];
            }
            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    const row = {};
                    for (let j = 0; j < headers.length; j++) {
                        row[headers[j]] = values[j].trim();
                    }
                    data.push(row);
                }
            }
            return data;
        }

        // Main function to render the dashboard
        function renderDashboard(data) {
            // Check for required columns
            const requiredColumns = ['age', 'gender', 'preferred_platform', 'satisfaction_score', 'avg_spending'];
            const headers = Object.keys(data[0] || {});
            const hasRequiredColumns = requiredColumns.every(col => headers.includes(col));
            if (!hasRequiredColumns) {
                statusMessage.textContent = 'ไฟล์ CSV ไม่มีคอลัมน์ที่จำเป็น (age, gender, preferred_platform, satisfaction_score, avg_spending)';
                dashboardContent.classList.add('hidden');
                return;
            }

            // Calculate Card values
            const userCount = data.length;
            const totalSatisfaction = data.reduce((sum, row) => sum + parseFloat(row.satisfaction_score), 0);
            const avgSatisfaction = (totalSatisfaction / userCount).toFixed(2);
            const totalSpending = data.reduce((sum, row) => sum + parseFloat(row.avg_spending), 0);
            const avgSpending = (totalSpending / userCount).toFixed(2);

            document.getElementById('userCount').textContent = userCount;
            document.getElementById('avgSatisfaction').textContent = avgSatisfaction;
            document.getElementById('avgSpending').textContent = parseFloat(avgSpending).toLocaleString('en-US');

            // Bar Chart for Platform data
            const platformCounts = data.reduce((counts, row) => {
                const platform = row.preferred_platform;
                counts[platform] = (counts[platform] || 0) + 1;
                return counts;
            }, {});

            const platformLabels = Object.keys(platformCounts);
            const platformData = Object.values(platformCounts);

            const ctx = document.getElementById('platformChart').getContext('2d');
            // Destroy the previous chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: platformLabels,
                    datasets: [{
                        label: 'จำนวนผู้ใช้งาน',
                        data: platformData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Populate filter dropdown
            const platformFilter = document.getElementById('platformFilter');
            platformFilter.innerHTML = '<option value="">ทั้งหมด</option>';
            platformLabels.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = platform;
                platformFilter.appendChild(option);
            });

            // Function to render the table based on filtered data
            function renderTable(filteredData) {
                const tableBody = document.querySelector('#dataTable tbody');
                const noResults = document.getElementById('noResults');
                tableBody.innerHTML = '';
                
                if (filteredData.length === 0) {
                    noResults.classList.remove('hidden');
                } else {
                    noResults.classList.add('hidden');
                    filteredData.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.classList.add('hover:bg-gray-100');
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.age || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.gender || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.preferred_platform || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.satisfaction_score || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(parseFloat(row.avg_spending) || 0).toLocaleString('en-US')}</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }
            }
            
            // Initial render
            renderTable(data);

            // Event listeners for search and filter
            const searchBox = document.getElementById('searchBox');
            searchBox.value = '';
            platformFilter.value = '';

            function applyFilters() {
                const searchTerm = searchBox.value.toLowerCase();
                const selectedPlatform = platformFilter.value;

                const filtered = data.filter(row => {
                    const platformMatch = selectedPlatform === '' || row.preferred_platform === selectedPlatform;
                    const searchMatch = Object.values(row).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                    return platformMatch && searchMatch;
                });
                renderTable(filtered);
            }

            searchBox.addEventListener('keyup', applyFilters);
            platformFilter.addEventListener('change', applyFilters);
        }

        // Event listener for loading data
        loadDataBtn.addEventListener('click', async () => {
            const url = sheetUrlInput.value.trim();
            if (!url) {
                statusMessage.textContent = 'กรุณาใส่ URL ของ Google Sheet';
                return;
            }

            statusMessage.textContent = 'กำลังโหลดข้อมูล...';
            loadDataBtn.disabled = true;
            dashboardContent.classList.add('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    statusMessage.textContent = 'ไฟล์ CSV ว่างเปล่าหรือมีรูปแบบไม่ถูกต้อง';
                    return;
                }
                
                statusMessage.textContent = 'โหลดข้อมูลสำเร็จแล้ว!';
                dashboardContent.classList.remove('hidden');
                renderDashboard(data);
            } catch (error) {
                console.error("Error fetching data:", error);
                statusMessage.textContent = 'เกิดข้อผิดพลาดในการดึงข้อมูล โปรดตรวจสอบ URL';
                dashboardContent.classList.add('hidden');
            } finally {
                loadDataBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
